# GEOS Height Correction

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.6569030.svg)](https://doi.org/10.5281/zenodo.6569030)

## Introduction

This software is a supplement to the publication “A Parallax Shift
Effect Correction Based on Cloud Height for Geostationary Satellites and
Radar Observations” [\[1\]](#ref-bielinski_parallax_2020).

Repository contains two programs which performs correction of cloud’s
parallax shift using its a priori known height. Programs are using
[Geostationary
projection](https://proj.org/operations/projections/geos.html)
[\[2\]](#ref-proj).

### Required libraries

C++ programs require following libraries to run:

- GDAL [\[3\]](#ref-gdal),
- boost-program_options [\[4\]](#ref-boost_program_options)
- dlib [\[5\]](#ref-dlib), [\[6\]](#ref-king_dlib-ml_2009)

## Raster correction

### C++ program

Program `geosheightcorrection` calculates new coordinates in
geostationary view of every pixel using its original coordinates
(geostationary coordinates of cloud’s image) and a priori known height
of cloud. Usually cloud height can be calculated using cloud top
temperature or in more sophisticated way - like CTH product provided by
Eumetcast [\[7\]](#ref-emetsat_mpefa_2011).

### Wrapping script

This repository contains script `perform_geos_height_correction.sh`
which allows to correct existing images in Geostationary Projection
using priori known height of clouds. Script produces raster in which
data connected with cloud top are moved to relevant nadir location.

To run, wrapping script requires above C++ program present in `PATH` and
installed GDAL [\[3\]](#ref-gdal) utilities including python scripts.

## Generation of correction tables

Program `geostablegenerator` generates parallax correction tables in
format similar to tables generated by Marianne Koenig
[\[8\]](#ref-marianne_koenig_parallax). Table generation could be
performed in parallel, thanks to `OpenMP` [\[9\]](#ref-openmp_2015).

## Build

Project can be build using Docker or CMake.

### Docker

To build project on docker please use following command.

``` shell
docker build -t geosheightcorrection .
```

Build docker image will contain both programs `geosheightcorrection`,
`geostablegenerator` and `perform_geos_height_correction.sh` script in
`PATH`. For detailed information about usage please read following
[section](#usage).

### CMake (Linux)

To build C++ programs on Linux it following elements are required:

- C++ compiler with support of C++11 a least (g++ is suggested),
- CMake program,
- make program (or other tool supported by CMake),
- GDAL library with headers,
- Boost program_options library with headers
- dlib with headers

To build C++ programs with CMake please execute following commands in
main repository directory:

``` shell
cmake build
cd build
make
```

After those steps in `build` directory should reside program
`geosheightcorrection` and `geostablegenerator` ready to use.

## Usage

### Assumptions

This correction software can be used either from docker or directly by
operation system.

#### Docker

For docker usage it is assumed that command is preceded by docker
prefix:

Powershell on Windows

``` powershell
docker run --rm -v "${pwd}/data:/app/data" -ti geosheightcorrection <executable_name> <executable_parameters>
```

On Linux:

``` shell
docker run --rm -v `pwd`/data:/app/data -ti geosheightcorrection <executable_name> <executable_parameters>
```

`pwd` should point to main repository directory.

#### Linux

In case of running correction executable directly in operating system it
is assumed that GDAL utilities and `geosheightcorrection` are present in
`PATH`.

### Sample Data

`data` directory contains sample data that could be used for evaluation
of C++ program and wrapping script.

Those data is following:

- `ctt_201507251300.tif` - cloud top temperature extracted from SEVIRI
  image (channel IR 10.8) [\[10\]](#ref-msg_0),
- `h_201507251300.tif` - cloud top height calculated with simple
  algorithm using data from `ctt_201507251300.tif`.

### C++ programs

#### Raster correction program

Raster correction program run without parameters:

``` shell
geosheightcorrection
```

will display option description:

``` text
GEOS Height correction options:
  --help                                Shows help message
  --input arg                           Location of image containing height 
                                        information.
  --output arg                          Location of result raster with 
                                        corrected coordiantes
  --height-band arg (=1)                Band with height information [m]. 
  --requierd-accuracy arg (=10)         Required accuracy [m].
  --numeric-method arg (=LEVENBERG_MARQUARD)
                                        Numeric method. Either:
                                        NETWON
                                        Netwon numeric method. I could be 
                                        lighter in computation effort. However 
                                        it fails to perform correction in 
                                        subsatellite point.
                                        LEVENBERG_MARQUARD
                                        Levenberg-Marquard numeric method. This
                                        method is more roboust. It allows for 
                                        correction near egde of view disc.
                                        
  --use-squared-target                  Use squared targed function.
  --iterations-limit arg (=100)         Maximum number of iteration per pixel.
```

To calculate corrected GEOS coordinates using raster
`h_201507251300.tif` please execute following command:

``` shell
geosheightcorrection --input data/h_201507251300.tif --output data/new_coordinates.tif
```

After that operation in `data` directory new file `new_coordinates.tif`
should be present. This raster will contain two `FLOAT_64` bands. Those
band will represent new coordinates (x and y respectively) in
geostationary source reference system (same as for input and output
image).

##### Wrapping script

Wrapping script can perform more complex processing which produces fully
adjusted image with approximately same content.

Wrapping script has following options:

- `--input` - path to image requiring correction,
- `--height` - path to image containing cloud height data (in meters),
- `--output` - location where corrected image will be saved,
- `--height-band` - number of band containing height information in
  height raster. If not specified `1` is assumed,
- `--algorithms` - list of interpolation algorithms for each band
  respectively. If not defined `average` is assumed for each band. For
  bands which contain quantified data by definition `nearest` algorithm
  is suggested. For more information please refer to help of `gdal_grid`
  program.

To run full correction and resampling of sample data please run
following command:

``` shell
perform_geos_height_correction.sh --input data/ctt_201507251300.tif --height data/h_201507251300.tif --output data/ctt_201507251300_corrected.tif 
```

After that command corrected raster `ctt_201507251300_corrected.tif`
should appear in `data` directory.

Alternatively raster can be corrected with different interpolation
algorithm

``` shell
perform_geos_height_correction.sh --input data/ctt_201507251300.tif --height data/h_201507251300.tif --output data/ctt_201507251300_corrected_nearest.tif --algorithms "nearest"
```

### Table generation program

> \[!NOTE\]  
> This program is intended to generate tables in format similar to those
> that can be found here [\[8\]](#ref-marianne_koenig_parallax). However
> due to fact, that original files are broken, the program output cannot
> be fully verified. One important difference is that this program don’t
> format in numbers in Fortran’s fixed digit numbers sheme, rather
> numbers are always printed with ~4 digit precision and always are
> separeted by spaces.

Table program run without parameters:

``` shell
geostablegenerator 
```

will display option description:

``` text
GEOS Height correction table generator options:
  --help                                Shows help message
  --projection-description arg          Description of geos projection in Proj 
                                        format, used to generate tables.
  --geotransform arg                    Six comma separated numbers 
                                        describining raster location in SRS. 
                                        See GDAL Raster Model.
  --image-dimensions arg                Comma separated image dimmensions: 
                                        width and height in pixels. See GDAL 
                                        Raster Model.
  --columns-scope arg                   Comma separated, 1 based, inclusive 
                                        scope for rasters columns. If 
                                        specified, generation of table will be 
                                        limited to those columns.
  --lines-scope arg                     Comma separated, 1 based, inclusive 
                                        scope for rasters lines. If specified, 
                                        generation of table will be limited to 
                                        those lines.
  --heights-range arg (=0.5,20,0.5)     Range and of cloud heights. Should 
                                        contain following comma separated 
                                        values min, max, step. All numbers 
                                        should be expressed in km.
  --output arg                          Location of result table
  --requierd-accuracy arg (=10)         Required accuracy [m].
  --numeric-method arg (=LEVENBERG_MARQUARD)
                                        Numeric method. Either:
                                        NETWON
                                        Netwon numeric method. I could be 
                                        lighter in computation effort. However 
                                        it fails to perform correction in 
                                        subsatellite point.
                                        LEVENBERG_MARQUARD
                                        Levenberg-Marquard numeric method. This
                                        method is more roboust. It allows for 
                                        correction near egde of view disc.
                                        
  --use-squared-target                  Use squared targed function.
  --iterations-limit arg (=100)         Maximum number of iteration per pixel.
```

to generate sample tables for scope of `ctt_201507251300.tif` first of
all it is necesseary to fetch projection, geotranform and image
dimmensionm. It can be acheived with following command (`jq` only helps
to filter output):

``` shell
gdalinfo -json -proj4 data/ctt_201507251300.tif | jq '.coordinateSystem.proj4,.geoTransform,.size'
```

which should yield following result:

``` json
"+proj=geos +lon_0=0 +h=35785831 +x_0=0 +y_0=0 +a=6378140 +rf=298.252981061492 +units=m +no_defs"
[
  670590.108,
  3000.4031658172607,
  0,
  4853152.121,
  0,
  -3000.4031658172607
]
[
  339,
  154
]
```

Those result can be used to generate table with following command:

``` shell
geostablegenerator --projection-description "+proj=geos +lon_0=0 +h=35785831 +x_0=0 +y_0=0 +a=6378140 +rf=298.252981061492 +units=m +no_defs" --geotransform "670590.1080000000074506,3000.4031658172607422,0.0,4853152.1210000002756715,0.0,-3000.4031658172607422" --image-dimensions 339,154 --output data/table.txt
```

To generate tables for entire disc for MSG satellite view (in this case
0° longitude), with orginal columns and lines numbering specified in MSG
documentation [\[11, Ch. 3.1.5\]](#ref-msg_format_2013) and by Marianne
Koenig [\[8\]](#ref-marianne_koenig_parallax), please use following
command:

> \[!WARNING\]  
> Execution of following commands will take a lot of time, and can
> consume large amount of disk space.

``` shell
geostablegenerator --projection-description "+proj=geos +h=35785831.0 +a=6378077 +b=6356577" --geotransform "5566500,-3000,0,-5566500,0,3000" --image-dimensions 3712,3712 --output data/table.txt
```

To limit generation process to certain area please use `--lines-scope`
and `--columns-scope`. For instance for northen east quater following
command can be used:

``` shell
geostablegenerator --projection-description "+proj=geos +h=35785831.0 +a=6378077 +b=6356577" --geotransform "5566500,-3000,0,-5566500,0,3000" --image-dimensions 3712,3712 --lines-scope 1857,3712 --columns-scope 1,1856 --output data/table.txt
```

## References

<div id="refs" class="references csl-bib-body" entry-spacing="0">

<div id="ref-bielinski_parallax_2020" class="csl-entry">

<span class="csl-left-margin">\[1\]
</span><span class="csl-right-inline">T. Bieliński, “A parallax shift
effect correction based on cloud height for geostationary satellites and
radar observations,” *Remote Sensing*, vol. 12, no. 3, p. 365, Jan.
2020, doi:
[10.3390/rs12030365](https://doi.org/10.3390/rs12030365).</span>

</div>

<div id="ref-proj" class="csl-entry">

<span class="csl-left-margin">\[2\]
</span><span class="csl-right-inline">PROJ contributors, “PROJ
coordinate transformation software library.” Open Source Geospatial
Foundation, 2024. doi:
[10.5281/zenodo.5884394](https://doi.org/10.5281/zenodo.5884394).</span>

</div>

<div id="ref-gdal" class="csl-entry">

<span class="csl-left-margin">\[3\]
</span><span class="csl-right-inline">E. Rouault *et al.*, “GDAL.”
Zenodo, Jul. 06, 2022. doi:
[10.5281/zenodo.6801315](https://doi.org/10.5281/zenodo.6801315).</span>

</div>

<div id="ref-boost_program_options" class="csl-entry">

<span class="csl-left-margin">\[4\]
</span><span class="csl-right-inline">“Boost program options library.”
Boost.org, May 17, 2024. Accessed: May 17, 2024. \[Online\]. Available:
<https://github.com/boostorg/program_options></span>

</div>

<div id="ref-dlib" class="csl-entry">

<span class="csl-left-margin">\[5\]
</span><span class="csl-right-inline">D. E. King, “Davisking/dlib.” May
17, 2024. Accessed: May 17, 2024. \[Online\]. Available:
<https://github.com/davisking/dlib></span>

</div>

<div id="ref-king_dlib-ml_2009" class="csl-entry">

<span class="csl-left-margin">\[6\]
</span><span class="csl-right-inline">D. E. King, “Dlib-ml: A machine
learning toolkit,” *Journal of Machine Learning Research*, vol. 10, pp.
1755–1758, 2009, Available:
<https://jmlr.csail.mit.edu/papers/volume10/king09a/king09a.pdf></span>

</div>

<div id="ref-emetsat_mpefa_2011" class="csl-entry">

<span class="csl-left-margin">\[7\]
</span><span class="csl-right-inline">“Meteorological products
extraction facility algorithm specification document.” 2011. Accessed:
May 17, 2024. \[Online\]. Available:
<https://www-cdn.eumetsat.int/files/2020-04/pdf_ten_spe_04022_msg_mpef.pdf></span>

</div>

<div id="ref-marianne_koenig_parallax" class="csl-entry">

<span class="csl-left-margin">\[8\]
</span><span class="csl-right-inline">Marianne Koenig, “Parallax
corrections convection working group.” Accessed: Apr. 13, 2023.
\[Online\]. Available:
<https://cwg.eumetsat.int/parallax-corrections/></span>

</div>

<div id="ref-openmp_2015" class="csl-entry">

<span class="csl-left-margin">\[9\]
</span><span class="csl-right-inline">“OpenMP application programming
interface version 4.5.” OpenMP Architecture Review Board, Nov. 2015.
Accessed: May 17, 2024. \[Online\]. Available:
<https://www.openmp.org/wp-content/uploads/openmp-4.5.pdf></span>

</div>

<div id="ref-msg_0" class="csl-entry">

<span class="csl-left-margin">\[10\]
</span><span class="csl-right-inline">“EUMETSAT image gallery
animation - meteosat 0 degree.” Accessed: May 17, 2024. \[Online\].
Available: <https://eumetview.eumetsat.int/static-images/MSG/></span>

</div>

<div id="ref-msg_format_2013" class="csl-entry">

<span class="csl-left-margin">\[11\]
</span><span class="csl-right-inline">“MSG level 1.5 image data format
description.” Eumetsat, Dec. 04, 2013. Accessed: May 22, 2024.
\[Online\]. Available:
<https://www-cdn.eumetsat.int/files/2020-05/pdf_ten_05105_msg_img_data.pdf></span>

</div>

</div>
